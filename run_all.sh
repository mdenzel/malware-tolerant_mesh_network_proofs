#!/bin/bash

#
#  @title:    Malware Tolerant (Mesh-)Network
#  @authors:  Michael Denzel
#  @date:     2018-02-26
#
#  Shellscript to generate and run ProVerif proofs for the Malware-Tolerant Network Architecture
#

### CONFIG ###
# (please alter this section as needed)
#proof generation
ONLY_GENERATE=0          #set to 1 to only generate proofs without executing them
FORCE_GENERATION=1       #set to 1 to enforce proof generation each time (not needed for ONLY_GENERATE)
CLEANUP=1                #set to 1 to enforce cleaning up the generated files after running (ignored for ONLY_GENERATE)
##############

#check that proverif and cpp (c-pre-processor) are installed
type proverif >/dev/null 2>&1 || { echo >&2 "Could not locate ProVerif. Aborting..." && exit -1; }
type cpp >/dev/null 2>&1 || { echo >&2 "Could not locate C-pre-processor (needed for proof generation). Aborting..." && exit -1; }

# ------------ Generate proofs -----------------

#check if generation is enforced or not all proofs exist
if [ $FORCE_GENERATION -eq 1 ] || [ $ONLY_GENERATE -eq 1 ] ||
       [ ! -d ./proofs/selfhealing_proverif.gen ]
then
    #generate proofs
    cd ./proofs
    ./generate.sh
    #go back to main directory
    cd ..
    
    #exit if only generation was requested
    if [ $ONLY_GENERATE -eq 1 ]; then
        exit 0
    fi
fi

# ------------ Run proofs -----------------
cd ./proofs

#execute
echo -e "\n--- Malware-Tolerant Network Proofs ---"
sh ./run.sh ./proofs-1_get_ticket.gen
echo -e "\n\n======================================\n"
sh ./run.sh ./proofs-2_veto.gen
echo -e "\n\n======================================\n"
sh ./run.sh ./proofs-3_bridge_join.gen
echo -e "\n\n======================================\n"

#go back to main directory
cd ..

# ------------ CLEANUP -----------------

if [ $CLEANUP -eq 1 ]; then
    echo -en "\nClean up: "
    rm -r ./proofs/proofs-*.gen
    if [ $? -eq 0 ]; then
        echo "success"
    else
        echo "failed"
    fi
fi
